#include "audioDataTransProcess.h"

#define SAMPLEBUS  10

//float fftDataOut[512] = {37.8631590000000,0.828396000000000,0.246357000000000,1.45782200000000,0.983559000000000,0.856345000000000,0.652223000000000,0.798736000000000,0.681419000000000,0.782444000000000,0.416792000000000,1.38194200000000,0.753757000000000,0.765341000000000,0.657247000000000,0.425144000000000,0.203820000000000,1.10129200000000,0.866254000000000,0.846836000000000,0.679053000000000,0.546115000000000,0.810364000000000,0.505067000000000,0.884668000000000,1.11934600000000,0.909837000000000,0.803535000000000,0.185681000000000,0.263178000000000,0.675850000000000,0.665226000000000,0.705045000000000,0.743142000000000,0.496245000000000,1.35530400000000,0.786728000000000,0.768877000000000,1.58250700000000,0.226707000000000,0.629162000000000,0.460548000000000,1.04307400000000,1.40310100000000,1.32672400000000,1.37916500000000,1.40759700000000,0.674054000000000,1.44144500000000,0.516891000000000,1.56614000000000,0.660826000000000,0.604613000000000,1.05548500000000,1.77445600000000,0.792568000000000,1.78155300000000,0.826347000000000,1.15953900000000,1.26107000000000,0.733062000000000,0.468276000000000,1.38450800000000,1.54006900000000,1.70996000000000,1.08064700000000,1.18246600000000,1.41490900000000,1.63830400000000,0.757547000000000,1.02081900000000,0.281611000000000,0.520315000000000,1.61354900000000,1.10976300000000,0.833344000000000,1.34811200000000,0.298755000000000,0.337451000000000,1.08846900000000,1.09039700000000,1.90657900000000,0.944038000000000,1.34600900000000,0.243303000000000,0.988061000000000,0.677738000000000,1.30916000000000,2.02648900000000,1.26085200000000,1.25678000000000,1.53809200000000,0.939040000000000,1.84183900000000,1.25892800000000,1.26667000000000,1.68817700000000,0.831145000000000,1.83442700000000,2.13791100000000,2.42715100000000,0.898301000000000,1.68957000000000,1.68526900000000,2.09753800000000,3.08200200000000,2.91864000000000,1.70312200000000,2.63939900000000,2.33093900000000,3.12559900000000,4.03840100000000,6.11609400000000,12.0172770000000,33.3815570000000,5.68725400000000,3.79732600000000,2.71213700000000,2.77554700000000,2.43350500000000,2.06389700000000,3.16574600000000,3.88146700000000,5.04392900000000,7.47012100000000,29.6661970000000,17.1737900000000,6.11243300000000,3.41717700000000,2.68117700000000,1.79377000000000,1.40775400000000,0.781908000000000,0.660731000000000,0.437471000000000,0.618240000000000,0.237005000000000,1.16779900000000,1.15700100000000,0.918453000000000,0.815678000000000,0.861155000000000,1.89292200000000,2.33519600000000,2.89351700000000,3.90165700000000,4.03523300000000,7.78302500000000,18.4755550000000,28.7101480000000,7.39119600000000,3.45803300000000,2.55223300000000,2.06837900000000,1.77458000000000,2.16147400000000,1.61306300000000,2.06197300000000,3.30984800000000,5.25314800000000,33.7348590000000,10.0969950000000,4.99232600000000,2.65909200000000,2.97622500000000,1.63252500000000,1.41927500000000,1.95547400000000,1.60929100000000,1.85982900000000,3.53946100000000,8.01483600000000,34.9937400000000,4.68928400000000,2.44355200000000,2.07919300000000,1.53907200000000,0.176944000000000,0.579200000000000,0.919136000000000,0.766317000000000,1.08803100000000,1.18130900000000,1.02246000000000,0.912099000000000,0.732496000000000,0.572966000000000,0.653234000000000,0.745715000000000,0.842871000000000,0.189097000000000,0.959991000000000,0.867840000000000,0.413701000000000,0.641897000000000,0.547118000000000,0.540173000000000,0.650358000000000,0.520779000000000,0.631755000000000,0.653774000000000,0.985569000000000,0.898491000000000,0.307652000000000,1.08678400000000,0.631829000000000,0.403214000000000,0.893004000000000,1.14580600000000,1.50075900000000,1.54277400000000,1.89622200000000,1.61599000000000,1.62838700000000,2.31203400000000,1.99179300000000,3.33631300000000,6.36785800000000,32.9856340000000,11.4558500000000,4.80704600000000,2.14757200000000,2.28071300000000,1.84357200000000,1.84036000000000,1.31219800000000,1.32352900000000,2.74406200000000,2.16445300000000,5.05845400000000,35.9447440000000,3.27865100000000,1.29676300000000,1.41670400000000,1.08786200000000,2.26547700000000,0.910874000000000,2.22223400000000,2.16369300000000,3.96780800000000,7.24761000000000,23.8601800000000,24.0631750000000,8.08371400000000,5.01691100000000,3.91103300000000,2.83884400000000,2.21078900000000,1.22648400000000,2.16039100000000,0.898325000000000,2.66345000000000,0.912897000000000,0.913132000000000,1.45296800000000,0.865070000000000,0.0777050000000000,0.527684000000000,0.622205000000000,0.652343000000000,0.942513000000000,0.484724000000000,1.13091500000000,0.655878000000000,1.12332500000000,0.926459000000000,1.39820100000000,0.942854000000000,0.114322000000000,0.185002000000000,0.163342000000000,0.984051000000000,0.185965000000000,1.05092100000000,0.224668000000000,1.31593400000000,0.520767000000000,0.318442000000000,0.992273000000000,0.675775000000000,0.627912000000000,0.729572000000000,1.27045600000000,0.479597000000000,1.16093100000000,1.74305600000000,1.49004800000000,2.70895700000000,36.5716060000000,2.87257700000000,0.862275000000000,1.18948000000000,1.69155800000000,1.40071600000000,1.84160100000000,2.30431000000000,2.76439300000000,4.28561200000000,7.43194400000000,21.5581870000000,25.3845390000000,8.64572500000000,4.78560300000000,3.06477800000000,3.49035500000000,2.03254900000000,2.47615100000000,2.05665800000000,2.29875100000000,2.02953400000000,4.48960200000000,35.0102810000000,7.12923300000000,3.07748300000000,2.43332200000000,2.68598800000000,1.69259500000000,1.33352200000000,1.05639700000000,1.49048800000000,1.12699600000000,1.00507300000000,2.36667300000000,1.19197700000000,0.585703000000000,0.737718000000000,0.544524000000000,1.20122700000000,0.573211000000000,0.249474000000000,0.449555000000000,0.929600000000000,0.0427500000000000,0.332013000000000,0.414532000000000,1.46120600000000,0.165961000000000,0.570596000000000,0.833485000000000,0.774017000000000,0.819936000000000,0.694840000000000,0.389694000000000,0.821914000000000,0.734118000000000,0.514286000000000,1.35158300000000,0.838737000000000,0.630834000000000,0.924875000000000,1.44138000000000,1.01519400000000,1.87518300000000,2.15831200000000,2.54827300000000,4.82913600000000,7.09316000000000,18.6006760000000,27.5012780000000,8.76124500000000,5.12093000000000,4.75778100000000,3.31227900000000,2.97486400000000,2.23892600000000,1.82619300000000,3.47905700000000,2.64686600000000,4.74855800000000,34.7743610000000,8.99117400000000,5.36056800000000,3.19884000000000,3.56053200000000,1.80343400000000,2.40020300000000,1.58311400000000,1.68002300000000,1.91867100000000,0.585219000000000,1.35116500000000,1.77823200000000,1.02788600000000,0.844120000000000,1.40385500000000,1.23111000000000,0.909014000000000,1.18089800000000,1.20127300000000,1.56872500000000,1.04131600000000,1.15411100000000,0.978102000000000,1.74771900000000,1.38690000000000,0.792170000000000,1.72342500000000,0.887543000000000,1.48370800000000,1.35586900000000,0.699002000000000,1.78896800000000,0.920103000000000,1.07563000000000,1.25770400000000,1.02671800000000,0.737191000000000,0.295960000000000,1.13740400000000,1.11693900000000,1.42953700000000,0.661219000000000,1.57545600000000,1.01768400000000,0.780793000000000,1.19243100000000,1.00073200000000,1.34232500000000,1.13250500000000,0.632757000000000,0.551233000000000,0.769524000000000,0.855930000000000,1.59928000000000,1.53208000000000,1.16625200000000,1.09662200000000,0.735630000000000,0.721423000000000,0.557641000000000,0.905726000000000,0.268359000000000,1.00449300000000,0.491666000000000,1.28066600000000,0.542331000000000,1.18569900000000,1.02347300000000,0.905708000000000,1.14511200000000,0.660966000000000,0.384408000000000,0.438414000000000,0.802087000000000,1.23487600000000,1.48701600000000,0.347823000000000,0.828253000000000,1.26350900000000,1.23101100000000,0.335701000000000,0.605110000000000,0.395408000000000,0.736021000000000,1.65477200000000,0.864365000000000,0.994680000000000,0.384167000000000,0.489455000000000,0.888837000000000,0.317591000000000,0.787848000000000,0.820369000000000,1.26598300000000,0.934243000000000,0.731641000000000,1.02350500000000,0.982800000000000,0.574618000000000,0.660022000000000,1.15585300000000,0.544529000000000,0.686683000000000,1.34567300000000,0.802946000000000,0.756557000000000,0.272573000000000,0.299572000000000,0.646505000000000,0.114359000000000,0.631216000000000,0.278518000000000,0.563820000000000,1.30297700000000,1.38073100000000,0.709773000000000,0.679773000000000,1.18569300000000,0.721508000000000,0.565200000000000,1.11948200000000,0.386746000000000,0.419035000000000,0.239237000000000,0.469573000000000,0.339403000000000,0.178702000000000,1.11315100000000,1.42001900000000,0.306726000000000,0.709254000000000,0.925480000000000,1.18298700000000,0.470072000000000,1.18083000000000,0.887158000000000,0.514445000000000,0.369723000000000,0.0865740000000000,0.998845000000000,0.200072000000000,0.627887000000000};
#define FFTOUTSIZE 1024
#define FFTINSIZE  2048
#define FREQMAX    44100
#define EXCEPTION  4000
#define FFTBUFFERSIZE 2048
#define FFTOUTSIZE  1024
#define ENERGYSTEP 44
#define NOISENORM  2500000
#define HEADRMF    30000000
	
	
int StartFreq = 0;
int EndFreq = 0;
int FreqStep = 0;
int DataLength = 0;	
int DataStep = 0;	

extern u8 sairecbuf1[];
extern u8 sairecbuf2[];
extern u8 saiplaybuf1[];
extern u8 saiplaybuf2[];	
extern u8 intFlag;
extern u16 ptr;
extern int16_t tempInt;
extern int IndexNum;
extern int8_t ByteDest[4];

extern float *recvAudioBuf;	
float *testdata; 	
int testIndex = 0;
extern int recvIndex; 
	
PART listers[5];
int listIndex = 0;
int hIndex = 0;
int pdex = 0;
int count = 0;
int DataStartFlag = 0;
uint64_t alTmp = 0;
uint64_t pubRecvBuf[SAMPLEBUS] = {0};
extern uint64_t dataRecvMaxSample;
extern uint64_t dataRecvMidSample;

u32 Bits[32];
extern float filterParamers[6];
extern bool filterChangeFlag1;

//flag
extern int dataRecvFlag;
int headFlag = 0;
int tailFlag = 0;

float leftData;
float rightData;
float FFTInputBuf[1024] = {0};
float FFTOutputBuf[1024] = {0};
float testOutput[1024];
int paramerIndex = 0;

#if 0
void AudioTransDataProcess(void)
{
	if (intFlag & 0x01)
	{
		ptr = 0;
		while (ptr < SAI_RX_DMA_BUF_SIZE)
		{
			tempInt = (sairecbuf1[ptr + 1] << 8) & 0xff00;
			tempInt |= sairecbuf1[ptr] & 0x00ff;
			
			leftData = (float)tempInt;
//			tempInt = (sairecbuf1[ptr + 3] << 8) & 0xff00;
//			tempInt = sairecbuf1[ptr + 2] & 0x00ff;
//			
//			rightData = (float)tempInt;

			if ((headFlag == 0 && tailFlag == 0 ) || 
					(headFlag == 2 && tailFlag == 0) || 
					(headFlag == 1 && tailFlag == 2)	||
					(headFlag == 1 && tailFlag == 0))
			{
				if (headFlag == 1 && tailFlag == 0)
				{
					if(recvIndex < 4000)
					{
						recvAudioBuf[recvIndex] = leftData;
						recvIndex++;					
					}
					else
					{
						memset(recvAudioBuf, 0, sizeof(float)* (recvIndex-1));
						printf("error!\n\r");
						headFlag = 0;
						tailFlag = 0;
						recvIndex = 0;
						dataRecvFlag = 0;
					}

				}	
				
				
				if (hIndex < 44)
				{
					alTmp += tempInt * tempInt;
					hIndex++;
				}
				else
				{
					if (dataRecvFlag == 0)
					{
						if (pdex < SAMPLEBUS)
						{
							if (30000000 < alTmp)
							{
								pubRecvBuf[pdex] = alTmp;
								pdex++;
							}
						}
						else
						{
							for (int i = 0; i < SAMPLEBUS; i++)
							{
								if (pubRecvBuf[i] / 2500000 < 10)
								{
									pdex--;
								}
							}
							if (pdex > 8)
							{
								dataRecvFlag = 1;
								pdex = 0;
								dataRecvMaxSample = pubRecvBuf[8] / 2500000;
							}
						}
					}
					else if (dataRecvFlag == 1)
					{
						alTmp = alTmp / 2000000;
						if (alTmp > dataRecvMaxSample)
						{
							DataStartFlag = 5;
						}
						else
						{
							DataStartFlag = 0;
						}
						
						ProcessDataStream(DataStartFlag);				
					}
					alTmp = 0;
					hIndex = 0;
				}					
			}		
			else if (headFlag == 1 &&  tailFlag == 1)
			{
				arm_copy_f32(recvAudioBuf,FFTInputBuf,2048);
				AnalysisBuffer();
				headFlag = 0;
				tailFlag = 0;
				recvIndex	= 0;			
			}
			ptr += 4;
		}
		intFlag &= 0xFE;
		
	}

	if (intFlag & 0x04)
	{
		ptr = 0;
		while (ptr < SAI_RX_DMA_BUF_SIZE)
		{
			tempInt = (sairecbuf2[ptr + 1] << 8) & 0xff00;
			tempInt |= sairecbuf2[ptr] & 0x00ff;
			
			leftData = (float)tempInt;
			

			if ((headFlag == 0 && tailFlag == 0 ) || 
					(headFlag == 2 && tailFlag == 0) || 
					(headFlag == 1 && tailFlag == 2) ||
					(headFlag == 1 && tailFlag == 0))
			{
				if (headFlag == 1 && tailFlag == 0)
				{
					if(recvIndex < 4000)
					{
						recvAudioBuf[recvIndex] = leftData;
						recvIndex++;					
					}
					else
					{
						memset(recvAudioBuf, 0, sizeof(float)* (recvIndex-1));
						printf("error!\n\r");
						headFlag = 0;
						tailFlag = 0;
						recvIndex = 0;
						dataRecvFlag = 0;
					}

				}	
				
				
				if (hIndex < 44)
				{
					alTmp += tempInt * tempInt;
					hIndex++;
				}
				else
				{
					if (dataRecvFlag == 0)
					{
						if (pdex < SAMPLEBUS)
						{
							if (30000000 < alTmp)
							{
								pubRecvBuf[pdex] = alTmp;
								pdex++;
							}
						}
						else
						{
							for (int i = 0; i < SAMPLEBUS; i++)
							{
								if (pubRecvBuf[i] / 2500000 < 10)
								{
									pdex--;
								}
							}
							if (pdex > 8)
							{
								dataRecvFlag = 1;
								pdex = 0;
								dataRecvMaxSample = pubRecvBuf[8] / 2500000;
							}
						}						
					}
					else if (dataRecvFlag == 1)
					{
						alTmp = alTmp / 2000000;
						if (alTmp > dataRecvMaxSample)
						{
							DataStartFlag = 5;
						}
						else
						{
							DataStartFlag = 0;
						}
						ProcessDataStream(DataStartFlag);						
					}
					alTmp = 0;
					hIndex = 0;
				}					
			}		
			else if (headFlag == 1 &&  tailFlag == 1)
			{
				arm_copy_f32(recvAudioBuf,FFTInputBuf,2048);	

				AnalysisBuffer();
				headFlag = 0;
				tailFlag = 0;
				recvIndex = 0;
			}
			ptr += 4;
		}
		intFlag &= 0xFB;
	}	
	
}
#endif

void AudioTransDataProcess(void)
{
	if (intFlag & 0x01)
	{
		ptr = 0;
		while (ptr < SAI_RX_DMA_BUF_SIZE)
		{
			tempInt = (sairecbuf1[ptr + 1] << 8) & 0xff00;
			tempInt |= sairecbuf1[ptr] & 0x00ff;
			
			leftData = (float)tempInt;
			if (recvIndex < 1024)
			{
				recvAudioBuf[recvIndex] = leftData;
				recvIndex++;
			}
			else
			{
				printf("-----------\n\r");
				arm_copy_f32(recvAudioBuf,FFTInputBuf,1024);				
				AnalysisBuffer();
				recvIndex = 0;
			}
			
			ptr += 4;
		}
		intFlag &= 0xFE;
	}
	
	if (intFlag & 0x04)
	{
		ptr = 0;
		while (ptr < SAI_RX_DMA_BUF_SIZE)
		{
			tempInt = (sairecbuf1[ptr + 1] << 8) & 0xff00;
			tempInt |= sairecbuf1[ptr] & 0x00ff;
			
			leftData = (float)tempInt;
			if (recvIndex < 1024)
			{
				recvAudioBuf[recvIndex] = leftData;
				recvIndex++;
			}
			else
			{
				printf("++++++++++\n\r");				
				arm_copy_f32(recvAudioBuf,FFTInputBuf,1024);
				AnalysisBuffer();
				recvIndex = 0;
			}			
			
			ptr += 4;
		}
		intFlag &= 0xFB;
	}
}

void AnalysisBuffer(void)
{
     arm_rfft_fast_instance_f32 S;
     uint8_t ifftFlag = 0;

     arm_rfft_fast_init_f32(&S, 1024);	
	
     arm_rfft_fast_f32(&S, FFTInputBuf, FFTOutputBuf, ifftFlag);

     arm_cmplx_mag_f32(FFTOutputBuf, testOutput, 1024);
		 FFTDataAnalysis();
}

void ProcessDataStream(int dataIn)
{
	if (listIndex < 4)
	{
		listers[listIndex].member = dataIn;
		listIndex++;
	}
	else
	{
		listers[listIndex].member = dataIn;
		listIndex = 0;
	}

	if(dataIn == 5 && headFlag == 0)
	{
		headFlag = 2;
		count++;
	}
	else if (headFlag == 2 && dataIn == 5)
	{
		count++;
	}
	else if (headFlag == 2 && dataIn != 5)
	{
		printf("head count = %d\n\r",count);
		if (count < 5)
		{
			dataRecvFlag = 0;
			headFlag = 0;
		}
		else
		{
			headFlag = 1;
			tailFlag = 0;
			count = 0;
		}
	}
	
	if (headFlag == 1 && dataIn == 5 && tailFlag == 0)
	{
		tailFlag = 2;
		count++;
	}
	else if (headFlag == 1 && tailFlag == 2 && dataIn == 5)
	{
		count++;
	}
	else if (tailFlag == 2 && dataIn != 5)
	{
		if (count < 5)
		{
			tailFlag = 0;
			count = 0;
			headFlag = 0;
			dataRecvFlag = 0;
		}
		else
		{
			printf("end count = %d\n\r",count);
			tailFlag = 1;
		}
	}
		
}

//0	0	0	0	0	0	0	0	0	1	1	0	1	1	1	0	0	0	1	1	1	0	0	0	1	1	1	0	0	0	1	1

	
//1024 512	 
//0->44100 22050  start 400  step 500  length 32 end 15900
	
void FFTDataAnalysis(void)
{
	int FreqHead = 0;
	int FreqTail = 0;
	StartFreq = 200;
	FreqStep = 300;
	DataLength = 32;
	EndFreq = StartFreq + FreqStep * (DataLength - 1);
	DataStep = (FFTOUTSIZE / 2) / DataLength;
	
	float MAX=0;
	for (int i = 0; i < 512; i ++)
	{
		MAX = testOutput[i] > MAX ? testOutput[i] : MAX;
	}

	float size = 44100 / 2 / 512;

	for (int i = 0; i < 512; i ++)
	{
		if (testOutput[i] > MAX / 4 && testOutput[i] > testOutput[i - 1] && testOutput[i] > testOutput[i + 1])
		{
//			printf("i = %d\n\r",i);
			for (int j = 0; j < DataLength; j++)
			{
				FreqHead = StartFreq + FreqStep * j - FreqStep / 2;
				FreqTail = StartFreq + FreqStep * j + FreqStep / 2;
				
				float Start = (float)FreqHead / size;
				float End = (float)FreqTail / size;

				if (i > Start && i < End)
				{
					Bits[j] = 1;
					continue;
				}
			}
		}
	}

	memset(FFTOutputBuf, 0, 1024);
	memset(FFTInputBuf, 0,1024);
	memset(testOutput, 0, 1024);

	for (int i = 0; i < 4; i++)
	{
		ByteDest[i] = ChangeBitToByte(&Bits[i * 8]);
		printf("ByteDest[%d] = %d\n\r", i, ByteDest[i]);
	}
	
//	if (dataCheckSum(ByteDest) == 0 && paramerIndex < 6)
//	{
//		for (int i = 0; i < 3; i++)
//		{
//			filterParamers[paramerIndex] =  (float)ByteDest[i];
//			paramerIndex++;
//		}
//		if (paramerIndex == 6)
//		{
////			for (int i = 0; i < 6; i++)
////			{
////				printf("filterParamers[%d] = %f\n\r",i,filterParamers[i]);
////			}
//			filterChangeFlag1 = TRUE;
//			paramerIndex = 0;
//		}		
//	}
//	else
//	{

//		paramerIndex = 0;
//	}
	memset(Bits,0, sizeof(int) * 32);
}

int dataCheckSum(int8_t *src)
{
	if ((src[0] | src[1] | src[2]) == src[3])
	{
		return 0;
	}
	else
	{
		return 1; 	
	}
}

u8 ChangeBitToByte(u32 *src)
{
	u32 tmp = 0;
	tmp = src[0] * 128 + src[1] * 64 + src[2] * 32 + src[3] * 16 + src[4] * 8 + src[5] * 4 + src[6] * 2 + src[7] * 1;
	return (u16)tmp;
}
